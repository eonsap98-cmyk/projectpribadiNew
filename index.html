<!DOCTYPE html>
<html lang="id">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem BKOM Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .modal { transition: opacity 0.3s ease, visibility 0.3s ease; z-index: 50; opacity: 0; visibility: hidden; }
        .modal.is-open { opacity: 1; visibility: visible; }
        .tab-button.active { color: #2563eb; border-bottom: 2px solid #2563eb; }
        /* Loading Spinner */
        #loading-screen { position: fixed; inset:0; background: rgba(255,255,255,0.9); z-index: 200; display: flex; justify-content: center; align-items: center; }
    </style>
</head>
<body class="text-gray-800">

    <div id="loading-screen">
        <div class="text-center">
            <i class="fas fa-circle-notch fa-spin text-4xl text-blue-600"></i>
            <p class="mt-2 font-semibold">Menghubungkan ke Server...</p>
        </div>
    </div>

    <div id="login-overlay" class="modal is-open fixed inset-0 bg-gray-900 bg-opacity-80 flex justify-center items-center p-4 z-[100]">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-8">
            <h1 class="text-xl font-bold text-center mb-4">BKOM System Login</h1>
            <form id="login-form">
                <input type="password" id="password" class="w-full px-4 py-2 border rounded mb-4" placeholder="Password Admin" required>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 rounded">Login</button>
            </form>
        </div>
    </div>

    <div class="min-h-screen flex flex-col">
        <header class="bg-gray-800 text-white p-4 flex justify-between items-center shadow-md">
            <div><h1 class="font-bold text-lg">Balai Kesehatan Olahraga Masyarakat</h1><p class="text-xs text-gray-400">Database Cloud Mode</p></div>
            <button id="logout-btn" class="hidden bg-red-600 px-3 py-1 rounded text-sm">Logout</button>
        </header>

        <main class="container mx-auto p-4 flex-grow">
            <div class="flex gap-4 border-b mb-6 overflow-x-auto pb-2">
                <button id="tab-members" class="tab-button font-semibold px-4 py-2 text-gray-600">Kelola Member</button>
                <button id="tab-check-in" class="tab-button font-semibold px-4 py-2 text-gray-600">Check-in</button>
                <button id="tab-visitors" class="tab-button font-semibold px-4 py-2 text-gray-600">Harian</button>
                <button id="tab-lockers" class="tab-button font-semibold px-4 py-2 text-gray-600">Loker</button>
                <button id="tab-reports" class="tab-button font-semibold px-4 py-2 text-gray-600">Laporan</button>
                <button id="tab-schedule" class="tab-button font-semibold px-4 py-2 text-gray-600">Jadwal</button>
            </div>

            <div id="view-members">
                <div class="flex justify-between mb-4">
                    <input type="search" id="search-member" placeholder="Cari Member..." class="border p-2 rounded w-1/3">
                    <button id="add-member-btn" class="bg-blue-600 text-white px-4 py-2 rounded">Tambah Member</button>
                </div>
                <div class="overflow-x-auto bg-white shadow rounded"><table class="w-full text-sm text-left"><thead class="bg-gray-100"><tr><th class="p-3">ID</th><th class="p-3">Nama</th><th class="p-3">Paket</th><th class="p-3">Tgl Selesai</th><th class="p-3">Status</th><th class="p-3">Loker</th><th class="p-3">Aksi</th></tr></thead><tbody id="member-list"></tbody></table></div>
            </div>

            <div id="view-visitors" class="hidden">
                <div class="flex justify-between mb-4">
                    <input type="date" id="visitor-date-picker" class="border p-2 rounded">
                    <button id="add-visitor-btn" class="bg-indigo-600 text-white px-4 py-2 rounded">Tambah Pengunjung</button>
                </div>
                <div class="overflow-x-auto bg-white shadow rounded"><table class="w-full text-sm text-left"><thead class="bg-gray-100"><tr><th class="p-3">ID</th><th class="p-3">Nama</th><th class="p-3">Biaya</th><th class="p-3">Loker</th><th class="p-3">Aksi</th></tr></thead><tbody id="visitor-list"></tbody></table></div>
            </div>

            <div id="view-check-in" class="hidden">
                <h2 class="text-xl font-bold mb-4">Check-in Member</h2>
                <input type="search" id="search-check-in" placeholder="Cari nama..." class="border p-2 rounded w-full mb-4">
                <div class="overflow-x-auto bg-white shadow rounded"><table class="w-full text-sm text-left"><thead class="bg-gray-100"><tr><th class="p-3">Nama</th><th class="p-3">Status</th><th class="p-3">Aksi</th></tr></thead><tbody id="check-in-list"></tbody></table></div>
            </div>
            
            <div id="view-lockers" class="hidden">
                <h2 class="text-xl font-bold mb-4">Status Loker</h2>
                <div id="locker-grid" class="grid grid-cols-5 gap-4"></div>
            </div>

            <div id="view-reports" class="hidden">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-4 rounded shadow text-center"><h3>Pendapatan Total</h3><p id="total-revenue" class="text-2xl font-bold text-green-600">Rp 0</p></div>
                    <div class="bg-white p-4 rounded shadow text-center"><h3>Member Aktif</h3><p id="total-active-members" class="text-2xl font-bold text-blue-600">0</p></div>
                </div>
                <h3 class="font-bold mb-2">Riwayat Transaksi</h3>
                <div class="overflow-y-auto h-64 bg-white shadow rounded"><table class="w-full text-sm text-left"><thead class="bg-gray-100 sticky top-0"><tr><th class="p-3">Tanggal</th><th class="p-3">Tipe</th><th class="p-3">Nama</th><th class="p-3">Nominal</th></tr></thead><tbody id="transaction-list"></tbody></table></div>
            </div>
            
             <div id="view-schedule" class="hidden">
                 <h2 class="text-xl font-bold mb-4">Jadwal Jaga</h2>
                 <div class="bg-white p-4 rounded shadow mb-4">
                     <input type="date" id="schedule-date" class="border p-2 rounded">
                     <div class="mt-4 grid grid-cols-2 gap-4">
                         <input id="sched-pagi" placeholder="Admin Pagi" class="border p-2 rounded">
                         <input id="sched-sore" placeholder="Admin Sore" class="border p-2 rounded">
                     </div>
                     <button id="save-schedule-btn" class="mt-4 bg-green-600 text-white px-4 py-2 rounded w-full">Simpan Jadwal</button>
                 </div>
            </div>
        </main>
    </div>

    <div id="member-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex justify-center items-center p-4">
        <div class="bg-white rounded w-full max-w-md p-6">
            <h3 class="font-bold text-xl mb-4">Form Member</h3>
            <form id="member-form" class="space-y-3">
                <input type="hidden" id="mem-id">
                <input id="mem-name" placeholder="Nama" class="w-full border p-2 rounded" required>
                <input id="mem-phone" placeholder="No HP" class="w-full border p-2 rounded">
                <select id="mem-gender" class="w-full border p-2 rounded"><option value="Laki-laki">Laki-laki</option><option value="Perempuan">Perempuan</option></select>
                <select id="mem-plan" class="w-full border p-2 rounded"><option value="1">1 Bulan</option><option value="3">3 Bulan</option></select>
                <select id="mem-locker" class="w-full border p-2 rounded"></select>
                <div class="flex justify-end gap-2 mt-4">
                    <button type="button" class="bg-gray-300 px-4 py-2 rounded close-modal">Batal</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- 1. SETUP SUPABASE ---
        // GANTI INI DENGAN DATA DARI SUPABASE ANDA
        const SUPABASE_URL = 'https://efbajidvpmernanozwhf.supabase.co'; 
        const SUPABASE_KEY = 'sb_secret_dTi_UFhGYjwAe9iOqCll8Q_Y0HD_Gkt';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- 2. GLOBAL STATE ---
        let members = [], visitors = [], transactions = [], lockers = [], checkins = [];
        const planPrices = { 1: 150000, 3: 400000 };
        let isLoggedIn = false;

        // --- 3. CORE FUNCTIONS (DB INTERACTIONS) ---
        
        async function loadData() {
            document.getElementById('loading-screen').style.display = 'flex';
            try {
                // Fetch Members
                let { data: dMem } = await supabase.from('members').select('*');
                if(dMem) members = dMem;

                // Fetch Lockers
                let { data: dLock } = await supabase.from('lockers').select('*').order('id');
                if(dLock) lockers = dLock;

                // Fetch Today's Visitors
                const today = new Date().toISOString().split('T')[0];
                let { data: dVis } = await supabase.from('visitors').select('*').eq('visit_date', today);
                if(dVis) visitors = dVis;

                // Fetch Transactions
                let { data: dTrans } = await supabase.from('transactions').select('*').order('created_at', {ascending: false});
                if(dTrans) transactions = dTrans;
                
                // Fetch Checkins
                 let { data: dCheck } = await supabase.from('checkins').select('*').eq('date', today);
                 if(dCheck) checkins = dCheck;

                renderAll();
            } catch (e) {
                console.error(e);
                alert("Gagal koneksi ke database. Cek internet.");
            } finally {
                document.getElementById('loading-screen').style.display = 'none';
            }
        }

        async function saveMember(data) {
            document.getElementById('loading-screen').style.display = 'flex';
            
            // 1. Upsert Member
            const { error } = await supabase.from('members').upsert({
                id: data.id,
                name: data.name,
                phone: data.phone,
                gender: data.gender,
                plan: data.plan,
                start_date: data.startDate,
                price: data.price,
                locker_id: data.lockerId || null,
                locker_returned: false
            });

            if(!error) {
                // 2. Insert Transaction Log
                await supabase.from('transactions').insert({
                    ref_id: data.id,
                    date: data.startDate,
                    type: 'Pendaftaran',
                    name: data.name,
                    amount: data.price,
                    description: 'Paket ' + data.plan + ' Bulan'
                });

                // 3. Update Locker Status if selected
                if(data.lockerId) {
                    await supabase.from('lockers').update({ 
                        status: 'in-use', assigned_to_id: data.id, assigned_to_name: data.name, type: 'Member' 
                    }).eq('id', data.lockerId);
                }

                await loadData(); // Refresh all data
                closeModal();
            } else {
                alert("Error: " + error.message);
            }
            document.getElementById('loading-screen').style.display = 'none';
        }

        async function deleteMember(id) {
            if(!confirm("Yakin hapus?")) return;
            // Get member to release locker
            const m = members.find(x => x.id === id);
            if(m && m.locker_id && !m.locker_returned) {
                 await supabase.from('lockers').update({ status: 'available', assigned_to_id: null, assigned_to_name: null, type: null }).eq('id', m.locker_id);
            }
            await supabase.from('members').delete().eq('id', id);
            await loadData();
        }

        async function memberCheckIn(id) {
            const today = new Date().toISOString().split('T')[0];
            await supabase.from('checkins').insert({
                member_id: id,
                date: today,
                time: new Date().toISOString()
            });
            alert("Check-in Berhasil!");
            await loadData();
        }

        // --- 4. RENDERING & UI LOGIC ---
        function renderAll() {
            // Render Members
            const tBody = document.getElementById('member-list');
            tBody.innerHTML = '';
            members.forEach(m => {
                const end = new Date(m.start_date);
                end.setMonth(end.getMonth() + m.plan);
                const isActive = end >= new Date();
                
                tBody.innerHTML += `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-3">${m.id}</td>
                        <td class="p-3">${m.name}</td>
                        <td class="p-3">${m.plan} Bln</td>
                        <td class="p-3">${end.toLocaleDateString('id-ID')}</td>
                        <td class="p-3"><span class="px-2 rounded text-xs text-white ${isActive ? 'bg-green-500' : 'bg-red-500'}">${isActive ? 'Aktif' : 'Habis'}</span></td>
                        <td class="p-3">${m.locker_id ? m.locker_id : '-'}</td>
                        <td class="p-3">
                            <button onclick="deleteMember('${m.id}')" class="text-red-600"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
            });

            // Render Lockers
            const lGrid = document.getElementById('locker-grid');
            const lockerSelect = document.getElementById('mem-locker');
            lGrid.innerHTML = '';
            lockerSelect.innerHTML = '<option value="">Pilih Loker</option>';
            
            lockers.forEach(l => {
                const isAvail = l.status === 'available';
                lGrid.innerHTML += `
                    <div class="p-2 border rounded text-center ${isAvail ? 'bg-green-100' : 'bg-red-100'}">
                        <div class="font-bold">${l.id}</div>
                        <div class="text-xs truncate">${isAvail ? 'Tersedia' : l.assigned_to_name}</div>
                    </div>`;
                if(isAvail) {
                    lockerSelect.innerHTML += `<option value="${l.id}">Loker ${l.id}</option>`;
                }
            });

            // Render Transactions
            const tList = document.getElementById('transaction-list');
            let total = 0;
            tList.innerHTML = '';
            transactions.forEach(t => {
                total += t.amount;
                tList.innerHTML += `<tr class="border-b"><td class="p-2">${t.date}</td><td class="p-2">${t.type}</td><td class="p-2">${t.name}</td><td class="p-2">Rp ${t.amount.toLocaleString()}</td></tr>`;
            });
            document.getElementById('total-revenue').textContent = `Rp ${total.toLocaleString()}`;
            document.getElementById('total-active-members').textContent = members.length;
            
            // Render Checkin List
            const ciList = document.getElementById('check-in-list');
            ciList.innerHTML = '';
            // Simple filter for demo
            members.forEach(m => {
                const checkedIn = checkins.find(c => c.member_id === m.id);
                ciList.innerHTML += `
                    <tr class="border-b">
                        <td class="p-3">${m.name}</td>
                        <td class="p-3">${checkedIn ? '<span class="text-green-600">Hadir</span>' : 'Belum'}</td>
                        <td class="p-3">
                            ${!checkedIn ? `<button onclick="memberCheckIn('${m.id}')" class="bg-teal-500 text-white px-3 py-1 rounded text-xs">Check-in</button>` : ''}
                        </td>
                    </tr>
                `
            })
        }

        // --- 5. EVENT LISTENERS ---
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            if(document.getElementById('password').value === 'bkomkalsel') {
                isLoggedIn = true;
                document.getElementById('login-overlay').classList.remove('is-open');
                document.getElementById('logout-btn').classList.remove('hidden');
                loadData(); // Load data saat login sukses
            } else { alert("Password Salah"); }
        });

        document.getElementById('member-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const idCount = members.length + 1;
            const newId = 'GM' + String(idCount).padStart(3, '0');
            const data = {
                id: newId,
                name: document.getElementById('mem-name').value,
                phone: document.getElementById('mem-phone').value,
                gender: document.getElementById('mem-gender').value,
                plan: parseInt(document.getElementById('mem-plan').value),
                lockerId: document.getElementById('mem-locker').value,
                startDate: new Date().toISOString().split('T')[0],
                price: planPrices[document.getElementById('mem-plan').value]
            };
            saveMember(data);
        });

        // Tabs Logic
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                document.querySelectorAll('main > div[id^="view-"]').forEach(v => v.classList.add('hidden'));
                document.getElementById(btn.id.replace('tab-', 'view-')).classList.remove('hidden');
            });
        });

        // Modal Logic
        const modal = document.getElementById('member-modal');
        document.getElementById('add-member-btn').onclick = () => modal.classList.add('is-open');
        document.querySelectorAll('.close-modal').forEach(b => b.onclick = closeModal);
        function closeModal() { modal.classList.remove('is-open'); }

        // Logout
        document.getElementById('logout-btn').onclick = () => location.reload();

    </script>
</body>
</html>
